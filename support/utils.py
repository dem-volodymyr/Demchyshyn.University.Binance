import difflib
import openai
import requests
from .models import FAQ, Comment, User
from django.conf import settings

# ÐšÐ¾Ð½ÑÑ‚Ð°Ð½Ñ‚Ð¸ Ð´Ð»Ñ Gemini API
API_URL = getattr(settings, 'OPEN_API')
headers = {
    "Content-Type": "application/json"
}
context = (
    "Xchange â€” Ñ†Ðµ ÑÑƒÑ‡Ð°ÑÐ½Ð° ÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð±Ñ–Ñ€Ð¶Ð°, ÑÐºÐ° Ð´Ð¾Ð·Ð²Ð¾Ð»ÑÑ” ÑˆÐ²Ð¸Ð´ÐºÐ¾, Ð·Ñ€ÑƒÑ‡Ð½Ð¾ Ñ‚Ð° Ð±ÐµÐ·Ð¿ÐµÑ‡Ð½Ð¾ Ñ‚Ð¾Ñ€Ð³ÑƒÐ²Ð°Ñ‚Ð¸ Ñ€Ñ–Ð·Ð½Ð¸Ð¼Ð¸ ÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð²Ð°Ð»ÑŽÑ‚Ð°Ð¼Ð¸. "
    "ÐžÑÐ½Ð¾Ð²Ð½Ñ– Ð¼Ð¾Ð´ÑƒÐ»Ñ– Ñ‚Ð° Ñ„ÑƒÐ½ÐºÑ†Ñ–Ñ— Ð±Ñ–Ñ€Ð¶Ñ– Xchange:\n"
    "- Ð¢Ð¾Ñ€Ð³Ñ–Ð²Ð»Ñ ÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð²Ð°Ð»ÑŽÑ‚Ð°Ð¼Ð¸: Ð¿Ñ–Ð´Ñ‚Ñ€Ð¸Ð¼ÐºÐ° Ð±Ð°Ð³Ð°Ñ‚ÑŒÐ¾Ñ… Ð²Ð°Ð»ÑŽÑ‚, ÑˆÐ²Ð¸Ð´ÐºÑ– Ñ‚Ð° Ð±ÐµÐ·Ð¿ÐµÑ‡Ð½Ñ– Ð¾Ð¿ÐµÑ€Ð°Ñ†Ñ–Ñ—, Ñ–Ð½Ð½Ð¾Ð²Ð°Ñ†Ñ–Ð¹Ð½Ñ– Ñ‚Ð¾Ñ€Ð³Ð¾Ð²Ñ– Ñ–Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð¸.\n"
    "- Ð“Ð°Ð¼Ð°Ð½ÐµÑ†ÑŒ: Ð·Ð±ÐµÑ€Ñ–Ð³Ð°Ð½Ð½Ñ, Ð¿Ð¾Ð¿Ð¾Ð²Ð½ÐµÐ½Ð½Ñ, Ð²Ð¸Ð²ÐµÐ´ÐµÐ½Ð½Ñ ÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð²Ð°Ð»ÑŽÑ‚, Ð¿ÐµÑ€ÐµÐ³Ð»ÑÐ´ Ð±Ð°Ð»Ð°Ð½ÑÑƒ, Ñ–ÑÑ‚Ð¾Ñ€Ñ–Ñ Ñ‚Ñ€Ð°Ð½Ð·Ð°ÐºÑ†Ñ–Ð¹.\n"
    "- ÐžÑ€Ð´ÐµÑ€Ð°: ÑÑ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ, Ð¿ÐµÑ€ÐµÐ³Ð»ÑÐ´, ÑƒÐ¿Ñ€Ð°Ð²Ð»Ñ–Ð½Ð½Ñ Ð¾Ñ€Ð´ÐµÑ€Ð°Ð¼Ð¸ Ð½Ð° ÐºÑƒÐ¿Ñ–Ð²Ð»ÑŽ/Ð¿Ñ€Ð¾Ð´Ð°Ð¶.\n"
    "- Ð ÐµÑ”ÑÑ‚Ñ€Ð°Ñ†Ñ–Ñ Ñ‚Ð° Ð¿Ñ€Ð¾Ñ„Ñ–Ð»ÑŒ: Ñ€ÐµÑ”ÑÑ‚Ñ€Ð°Ñ†Ñ–Ñ, Ð²Ñ…Ñ–Ð´, Ñ€ÐµÐ´Ð°Ð³ÑƒÐ²Ð°Ð½Ð½Ñ Ð¿Ñ€Ð¾Ñ„Ñ–Ð»ÑŽ, Ð´Ð²Ð¾Ñ„Ð°ÐºÑ‚Ð¾Ñ€Ð½Ð° Ð°ÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ñ–ÐºÐ°Ñ†Ñ–Ñ.\n"
    "- Ð ÐµÑ„ÐµÑ€Ð°Ð»ÑŒÐ½Ð° ÑÐ¸ÑÑ‚ÐµÐ¼Ð°: Ð·Ð°Ð¿Ñ€Ð¾ÑˆÐµÐ½Ð½Ñ Ð´Ñ€ÑƒÐ·Ñ–Ð², Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ð½Ð½Ñ Ð±Ð¾Ð½ÑƒÑÑ–Ð².\n"
    "- ÐŸÑ–Ð´Ñ‚Ñ€Ð¸Ð¼ÐºÐ°: ÑÐ¸ÑÑ‚ÐµÐ¼Ð° Ñ‚Ñ–ÐºÐµÑ‚Ñ–Ð², FAQ, AI-Ð¿Ð¾Ð¼Ñ–Ñ‡Ð½Ð¸Ðº, email-Ð¿Ñ–Ð´Ñ‚Ñ€Ð¸Ð¼ÐºÐ°.\n"
    "- ÐÐ½Ð°Ð»Ñ–Ñ‚Ð¸ÐºÐ° Ñ‚Ð° Ñ‚Ñ€ÐµÐºÑ–Ð½Ð³: Ð¿ÐµÑ€ÐµÐ³Ð»ÑÐ´ Ñ€Ð¸Ð½ÐºÐ¾Ð²Ð¸Ñ… Ð´Ð°Ð½Ð¸Ñ…, Ð°Ð½Ð°Ð»Ñ–Ñ‚Ð¸ÐºÐ°, Ð³Ñ€Ð°Ñ„Ñ–ÐºÐ¸.\n"
    "- Ð‘ÐµÐ·Ð¿ÐµÐºÐ°: Ð´Ð²Ð¾Ñ„Ð°ÐºÑ‚Ð¾Ñ€Ð½Ð° Ð°ÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ñ–ÐºÐ°Ñ†Ñ–Ñ, email-Ð¿Ñ–Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¶ÐµÐ½Ð½Ñ, Ð·Ð°Ñ…Ð¸ÑÑ‚ Ð°ÐºÐ°ÑƒÐ½Ñ‚Ð°.\n"
    "- Ð›Ð¾ÐºÐ°Ð»Ñ–Ð·Ð°Ñ†Ñ–Ñ: Ð¿Ñ–Ð´Ñ‚Ñ€Ð¸Ð¼ÐºÐ° Ñ€Ñ–Ð·Ð½Ð¸Ñ… Ð¼Ð¾Ð² (Ð¾ÑÐ½Ð¾Ð²Ð½Ð° â€” ÑƒÐºÑ€Ð°Ñ—Ð½ÑÑŒÐºÐ°/Ð°Ð½Ð³Ð»Ñ–Ð¹ÑÑŒÐºÐ°).\n\n"
    "ÐŸÐ»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ð° Ð¿Ñ–Ð´Ñ‚Ñ€Ð¸Ð¼ÑƒÑ” Ð²ÐµÐ»Ð¸ÐºÐ¸Ð¹ Ð²Ð¸Ð±Ñ–Ñ€ Ñ†Ð¸Ñ„Ñ€Ð¾Ð²Ð¸Ñ… Ð°ÐºÑ‚Ð¸Ð²Ñ–Ð², Ð½Ð°Ð´Ð°Ñ” Ñ–Ð½Ð½Ð¾Ð²Ð°Ñ†Ñ–Ð¹Ð½Ñ– Ñ‚Ð¾Ñ€Ð³Ð¾Ð²Ñ– Ñ–Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð¸, Ð° Ñ‚Ð°ÐºÐ¾Ð¶ Ð·Ñ€ÑƒÑ‡Ð½Ð¸Ð¹ Ð³Ð°Ð¼Ð°Ð½ÐµÑ†ÑŒ Ð´Ð»Ñ Ð·Ð±ÐµÑ€Ñ–Ð³Ð°Ð½Ð½Ñ, Ð¿Ð¾Ð¿Ð¾Ð²Ð½ÐµÐ½Ð½Ñ Ñ‚Ð° Ð²Ð¸Ð²ÐµÐ´ÐµÐ½Ð½Ñ ÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð²Ð°Ð»ÑŽÑ‚Ð¸. "
    "ÐšÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ñ– Ð¼Ð¾Ð¶ÑƒÑ‚ÑŒ ÑÑ‚Ð²Ð¾Ñ€ÑŽÐ²Ð°Ñ‚Ð¸ Ð¾Ñ€Ð´ÐµÑ€Ð¸ Ð½Ð° ÐºÑƒÐ¿Ñ–Ð²Ð»ÑŽ Ñ‚Ð° Ð¿Ñ€Ð¾Ð´Ð°Ð¶, Ð¿ÐµÑ€ÐµÐ³Ð»ÑÐ´Ð°Ñ‚Ð¸ Ñ–ÑÑ‚Ð¾Ñ€Ñ–ÑŽ Ñ‚Ñ€Ð°Ð½Ð·Ð°ÐºÑ†Ñ–Ð¹, ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‚Ð¸ÑÑ Ñ€ÐµÑ„ÐµÑ€Ð°Ð»ÑŒÐ½Ð¾ÑŽ Ð¿Ñ€Ð¾Ð³Ñ€Ð°Ð¼Ð¾ÑŽ, Ð° Ñ‚Ð°ÐºÐ¾Ð¶ Ð¾Ñ‚Ñ€Ð¸Ð¼ÑƒÐ²Ð°Ñ‚Ð¸ Ð°Ð½Ð°Ð»Ñ–Ñ‚Ð¸ÐºÑƒ Ñ‚Ð° Ñ€Ð¸Ð½ÐºÐ¾Ð²Ñ– Ð´Ð°Ð½Ñ–. "
    "Ð”Ð»Ñ Ð±ÐµÐ·Ð¿ÐµÐºÐ¸ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð° Ð´Ð²Ð¾Ñ„Ð°ÐºÑ‚Ð¾Ñ€Ð½Ð° Ð°ÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ñ–ÐºÐ°Ñ†Ñ–Ñ, email-Ð¿Ñ–Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¶ÐµÐ½Ð½Ñ Ñ‚Ð° ÑÑƒÑ‡Ð°ÑÐ½Ñ– Ð·Ð°ÑÐ¾Ð±Ð¸ Ð·Ð°Ñ…Ð¸ÑÑ‚Ñƒ Ð°ÐºÐ°ÑƒÐ½Ñ‚Ð°. "
    "ÐŸÐ»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ð° Ð¿Ñ–Ð´Ñ…Ð¾Ð´Ð¸Ñ‚ÑŒ ÑÐº Ð´Ð»Ñ Ð½Ð¾Ð²Ð°Ñ‡ÐºÑ–Ð², Ñ‚Ð°Ðº Ñ– Ð´Ð»Ñ Ð´Ð¾ÑÐ²Ñ–Ð´Ñ‡ÐµÐ½Ð¸Ñ… Ñ‚Ñ€ÐµÐ¹Ð´ÐµÑ€Ñ–Ð². "
    "ÐŸÑ–Ð´Ñ‚Ñ€Ð¸Ð¼ÐºÐ° ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ñ–Ð² Ð·Ð´Ñ–Ð¹ÑÐ½ÑŽÑ”Ñ‚ÑŒÑÑ Ñ‡ÐµÑ€ÐµÐ· ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ Ñ‚Ñ–ÐºÐµÑ‚Ñ–Ð², FAQ, AI-Ð¿Ð¾Ð¼Ñ–Ñ‡Ð½Ð¸ÐºÐ° Ñ‚Ð° email. "
    "Ð’Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ð¹ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¾, Ð¿Ñ€Ð¾ÑÑ‚Ð¾ÑŽ Ñ– Ð´Ñ€ÑƒÐ¶Ð½ÑŒÐ¾ÑŽ Ð¼Ð¾Ð²Ð¾ÑŽ, Ð±ÐµÐ· Ð·Ð°Ð¹Ð²Ð¸Ñ… Ñ„Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ð¾ÑÑ‚ÐµÐ¹, Ð½Ðµ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€ÑŽÐ¹ Ð¿Ð¸Ñ‚Ð°Ð½Ð½Ñ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ð°, Ð½Ðµ Ð²Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÐ¹ Ñ€Ð¾Ð·Ð¼Ñ–Ñ‚ÐºÑƒ Markdown (##, **, *, Ñ‚Ð¾Ñ‰Ð¾), Ð½Ðµ Ð´Ð¾Ð´Ð°Ð²Ð°Ð¹ Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÑ–Ð² Ñ– Ð½Ðµ Ð¿Ñ–Ð´Ð¿Ð¸ÑÑƒÐ¹ÑÑ ÑÐº ÐºÐ¾Ð¼Ð°Ð½Ð´Ð° Ð¿Ñ–Ð´Ñ‚Ñ€Ð¸Ð¼ÐºÐ¸. "
    "Ð¯ÐºÑ‰Ð¾ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð´ÑÐºÑƒÑ” Ð°Ð±Ð¾ Ð¿Ð¸ÑˆÐµ Ñ‰Ð¾ÑÑŒ Ð½Ð° ÐºÑˆÑ‚Ð°Ð»Ñ‚ Â«Ð´ÑÐºÑƒÑŽÂ», Â«Ð¾ÐºÂ», Â«Ð²ÑÐµ Ð·Ñ€Ð¾Ð·ÑƒÐ¼Ñ–Ð»Ð¾Â», Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ð¹ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¾: Â«Ð‘ÑƒÐ´ÑŒ Ð»Ð°ÑÐºÐ°!Â» Ð°Ð±Ð¾ Â«Ð Ð°Ð´Ñ– Ð´Ð¾Ð¿Ð¾Ð¼Ð¾Ð³Ñ‚Ð¸!Â» Ñ– Ð½Ðµ Ð´Ð°Ð²Ð°Ð¹ Ñ–Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ñ–Ð¹ Ñ‡Ð¸ Ð¿Ð¾ÑÑÐ½ÐµÐ½ÑŒ. "
    "Ð¯ÐºÑ‰Ð¾ Ð¿Ð¸Ñ‚Ð°Ð½Ð½Ñ ÑÑ‚Ð¾ÑÑƒÑ”Ñ‚ÑŒÑÑ Ñ„ÑƒÐ½ÐºÑ†Ñ–Ð¹ Ð±Ñ–Ñ€Ð¶Ñ–, Ð´Ð°Ð²Ð°Ð¹ Ñ‡Ñ–Ñ‚ÐºÑƒ, Ð¿Ð¾ÐºÑ€Ð¾ÐºÐ¾Ð²Ñƒ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´ÑŒ, Ð°Ð»Ðµ Ð½Ðµ Ð±Ñ–Ð»ÑŒÑˆÐµ 3-5 Ñ€ÐµÑ‡ÐµÐ½ÑŒ. "
    "Ð¯ÐºÑ‰Ð¾ Ð½Ðµ Ð·Ð½Ð°Ñ”Ñˆ Ñ‚Ð¾Ñ‡Ð½Ð¾Ñ— Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ñ– â€” Ð¿Ð¾Ñ€Ð°Ð´ÑŒ Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚Ð¸ÑÑ Ð´Ð¾ ÑÐ»ÑƒÐ¶Ð±Ð¸ Ð¿Ñ–Ð´Ñ‚Ñ€Ð¸Ð¼ÐºÐ¸ Xchange.\n\n"
)

def generate_ai_response(ticket, comment=None):
    # Only respond to open tickets
    if ticket.status != 'open':
        return

    ai_user = get_or_create_ai_user()

    # Ð’Ð¸Ð·Ð½Ð°Ñ‡Ð°Ñ”Ð¼Ð¾ Ñ‚ÐµÐºÑÑ‚ Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ñ–Ð·Ñƒ (FAQ/AI): ÐºÐ¾Ð¼ÐµÐ½Ñ‚Ð°Ñ€ Ð°Ð±Ð¾ description Ñ‚Ñ–ÐºÐµÑ‚Ñƒ
    text_for_faq = comment.text if comment else ticket.description

    # First check FAQs
    faq_match = find_similar_faq(text_for_faq)
    if faq_match:
        Comment.objects.create(
            ticket=ticket,
            user=ai_user,
            text=f"ðŸ” I found a related FAQ:\n\n{faq_match.question}\n{faq_match.answer}",
            is_ai=True
        )
        return
    try:
        prompt_text = context + f"Ticket Title: {ticket.title}\n\nDescription: {text_for_faq}"
        print(prompt_text)
        data = {
            "contents": [
                {
                    "parts": [
                        {
                            "text": prompt_text
                        }
                    ]
                }
            ]
        }
        response = requests.post(API_URL, headers=headers, json=data)
        if response.status_code == 200:
            resp_json = response.json()
            try:
                text = resp_json["candidates"][0]["content"]["parts"][0]["text"]
            except (KeyError, IndexError) as e:
                text = f"ÐÐµ Ð²Ð´Ð°Ð»Ð¾ÑÑ Ð²Ð¸Ñ‚ÑÐ³Ñ‚Ð¸ Ñ‚ÐµÐºÑÑ‚ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ñ–."
        else:
            text = f"ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° {response.status_code}: {response.text}"
        Comment.objects.create(
            ticket=ticket,
            user=ai_user,
            text=text,
            is_ai=True
        )
    except Exception as e:
        # Fallback if AI fails
        Comment.objects.create(
            ticket=ticket,
            user=ai_user,
            text=f"âš ï¸ ÐÐ°Ñˆ AI Ð½Ð°Ñ€Ð°Ð·Ñ– Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¸Ð¹. Ð›ÑŽÐ´ÑÑŒÐºÐ¸Ð¹ Ð°Ð³ÐµÐ½Ñ‚ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–ÑÑ‚ÑŒ Ð½ÐµÐ·Ð°Ð±Ð°Ñ€Ð¾Ð¼. ({e})",
            is_ai=True
        )


def get_or_create_ai_user():
    ai_user, created = User.objects.get_or_create(
        username='AI_Helper',
        defaults={
            'email': 'ai@example.com',
            'password': 'unusablepassword'
        }
    )
    if created:
        ai_user.set_unusable_password()
        ai_user.save()
    return ai_user


def find_similar_faq(text):
    faqs = FAQ.objects.all()
    best_match = None
    best_ratio = 0
    for faq in faqs:
        ratio = difflib.SequenceMatcher(None, text.lower(), faq.question.lower()).ratio()
        if ratio > best_ratio:
            best_ratio = ratio
            best_match = faq
    return best_match if best_ratio > 0.6 else None
